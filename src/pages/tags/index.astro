---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import onlyCurrent from "../../scripts/filters";
const pageTitle = "Tags";
const allPosts = (await getCollection("blog")).filter(onlyCurrent);

// Collate all tags from all posts and count posts per tag
const tagCounts = allPosts
  .flatMap((post: any) => post.data.tags)
  .reduce((acc: Record<string, number>, tag: string) => {
    acc[tag] = (acc[tag] || 0) + 1;
    return acc;
  }, {});

const tags = Object.entries(tagCounts).sort(([tagA], [tagB]) =>
  tagA.localeCompare(tagB)
);

const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();

const collectionJsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: "Blog Tags",
  description: "Browse blog posts by tag",
  url: canonicalURL,
};
---

<BaseLayout pageTitle={pageTitle}>
  <script slot="head" is:raw is:inline
    type="application/ld+json"
    set:html={JSON.stringify(collectionJsonLd)}
  />
  <h1>Tags</h1>

  <p>Find posts categorized by tags:</p>
  <div class="tags">
    {
      tags.map(([tag, count]) => (
        <p class="tag">
          <a href={`/tags/${tag}`}>{tag}</a> ({count})
        </p>
      ))
    }
  </div>
</BaseLayout>

<style>
  a {
    color: #00539f;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
  }

  .tag {
    margin: 0.25em;
    border: dotted 1px #a1a1a1;
    border-radius: 0.5em;
    padding: 0.5em 1em;
    font-size: 1.15em;
    background-color: #f8fcfd;
  }

  :global(.dark) .tag {
    background-color: #1a1a1a;
    border-color: #5a5959;
    color: #f0f0f0;
  }

  :global(.dark) a {
    color: #6eb5ff;
  }
</style>
